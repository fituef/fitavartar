var app = {};
app.avatarCreator = function (a) {
    function t() {
        c.change(function (a) {
            var t = e(a.target.value);
            l.val(t), s = a.target.files[0]
        }), u.change(function (a) {
            var t = e(a.target.value);
            v.val(t), h = a.target.files[0]
        }), g.on("click", function () {
            NProgress.start(), NProgress.set(.5);
            var a = i();
            a && a.length > 0 && (alert(a), NProgress.done())
        }), f.on("click", function () {
            var a = document.getElementById("final-avatar");
            if (!r(a)) {
                var t = a.toDataURL();
                download(t, m, "image/png")
            }
        })
    }

    function e(a) {
        return a.replace(/^.*[\\\/]/, "")
    }

    function n() {
        return !(!s || !h) && ("image" === s.type.split("/")[0] && "image" === h.type.split("/")[0])
    }

    function r(a) {
        var t = document.createElement("canvas");
        return t.width = d, t.height = p, a.toDataURL() === t.toDataURL()
    }

    function i() {
        var a = document.getElementById("final-avatar"),
            t = a.getContext("2d");
        if (!n()) return I.INPUT_FILES;
        var e = [URL.createObjectURL(h), URL.createObjectURL(s)],
            r = [],
            i = e.length;
        $.each(e, function () {
            var a = new Image;
            r.push(a), a.onload = function () {
                i--, i || ($.each(r, function (a, e) {
                    if (0 === a) {
                        var n = o(this.width + 100, this.height + 100);
                        t.drawImage(this, n[0] / 2, n[1] / 2, this.width - n[0], this.height - n[1], 0, 0, d, p)
                    } else t.drawImage(this, 0, 0, d, p)
                }), NProgress.done())
            }, a.src = this
        })
    }

    function o(a, t) {
        var e = [];
        return a > t ? (e[0] = a - t, e[1] = 0) : (e[0] = 0, e[1] = t - a), e
    }
    var c = $("#avatar-frame-btn"),
        l = $("#avatar-frame-path"),
        u = $("#avatar-btn"),
        v = $("#avatar-path"),
        g = ($("#final-avatar"), $("#avatar-generate")),
        f = $("#avatar-download"),
        s = null,
        h = null,
        d = 1024,
        p = 1024,
        m = "Avatar.png",
        I = {
            INPUT_FILES: "Input files are incorrect!",
            UNKNOWN: "Error! Please try again."
        };
    return a.initialize = function () {
        t()
    }, a
}(app), $(document).ready(function () {
    app.avatarCreator.initialize()
});